!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.LoomSE=t():e.LoomSE=t()}(window,(function(){return function(e){var t={};function r(n){if(t[n])return t[n].exports;var i=t[n]={i:n,l:!1,exports:{}};return e[n].call(i.exports,i,i.exports,r),i.l=!0,i.exports}return r.m=e,r.c=t,r.d=function(e,t,n){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e)r.d(n,i,function(t){return e[t]}.bind(null,i));return n},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=1)}([function(e){e.exports=JSON.parse('{"private":false,"name":"loomse","version":"0.6.5","description":"Interactive storytelling for the modern web","author":"Franco Speziali","license":"GPL-3.0","homepage":"http://www.loomse.org/","repository":{"type":"git","url":"https://github.com/WeMakeMachines/loomse.git"},"main":"./dist/loomse.min.js","scripts":{"dev":"webpack --config webpack.config.js --devtool=\'source-map\' --watch --mode=\'development\'","build":"webpack --config webpack.config.js --mode=\'production\' -o dist/loomse.min.js","prettier":"prettier --write \'source/**/*.js\'","eslint":"eslint source","test":"jest"},"devDependencies":{"@babel/cli":"7.11.6","@babel/core":"^7.11.6","@babel/preset-env":"^7.11.5","babel-eslint":"^10.1.0","babel-jest":"^26.3.0","babel-loader":"^8.1.0","eslint":"^7.9.0","eslint-plugin-jest":"^24.0.2","jest":"^26.4.2","prettier":"1.19.1","webpack":"^4.44.2","webpack-cli":"^3.3.12"},"dependencies":{"redom":"^3.27.1"}}')},function(e,t,r){"use strict";function n(e,t){var r=function(e){for(var t=e.split(/([#.])/),r="",n="",i=[],o=0;o<t.length;o++){var s=t[o];"#"===s?n=t[++o]:"."===s?i.push(t[++o]):s.length&&(r=s)}return{tag:r||"div",id:n,className:i.join(" ")}}(e),n=r.tag,i=r.id,o=r.className,s=t?document.createElementNS(t,n):document.createElement(n);return i&&(s.id=i),o&&(t?s.setAttribute("class",o):s.className=o),s}function i(e,t){var r=g(e),n=g(t);return t===n&&n.__redom_view&&(t=n.__redom_view),n.parentNode&&(o(t,n,r),r.removeChild(n)),t}function o(e,t,r){var n=t.__redom_lifecycle;if(s(n))t.__redom_lifecycle={};else{var i=r;for(t.__redom_mounted&&u(t,"onunmount");i;){var o=i.__redom_lifecycle||{};for(var c in n)o[c]&&(o[c]-=n[c]);s(o)&&(i.__redom_lifecycle=null),i=i.parentNode}}}function s(e){if(null==e)return!0;for(var t in e)if(e[t])return!1;return!0}r.r(t),r.d(t,"default",(function(){return ye}));var c=["onmount","onremount","onunmount"],a="undefined"!=typeof window&&"ShadowRoot"in window;function l(e,t,r,n){var i=g(e),s=g(t);t===s&&s.__redom_view&&(t=s.__redom_view),t!==s&&(s.__redom_view=t);var l=s.__redom_mounted,d=s.parentNode;return l&&d!==i&&o(0,s,d),null!=r?n?i.replaceChild(s,g(r)):i.insertBefore(s,g(r)):i.appendChild(s),function(e,t,r,n){for(var i=t.__redom_lifecycle||(t.__redom_lifecycle={}),o=r===n,s=!1,l=0,d=c;l<d.length;l+=1){var h=d[l];o||e!==t&&h in e&&(i[h]=(i[h]||0)+1),i[h]&&(s=!0)}if(!s)return void(t.__redom_lifecycle={});var p=r,f=!1;(o||p&&p.__redom_mounted)&&(u(t,o?"onremount":"onmount"),f=!0);for(;p;){var v=p.parentNode,b=p.__redom_lifecycle||(p.__redom_lifecycle={});for(var y in i)b[y]=(b[y]||0)+i[y];if(f)break;(p.nodeType===Node.DOCUMENT_NODE||a&&p instanceof ShadowRoot||v&&v.__redom_mounted)&&(u(p,o?"onremount":"onmount"),f=!0),p=v}}(t,s,i,d),t}function u(e,t){"onmount"===t||"onremount"===t?e.__redom_mounted=!0:"onunmount"===t&&(e.__redom_mounted=!1);var r=e.__redom_lifecycle;if(r){var n=e.__redom_view,i=0;for(var o in n&&n[t]&&n[t](),r)o&&i++;if(i)for(var s=e.firstChild;s;){var c=s.nextSibling;u(s,t),s=c}}}function d(e,t,r){var n=g(e);if("object"==typeof t)for(var i in t)h(n,i,t[i]);else h(n,t,r)}function h(e,t,r){e.style[t]=null==r?"":r}var p="http://www.w3.org/1999/xlink";function f(e,t,r,n){var i=g(e);if("object"==typeof t)for(var o in t)f(i,o,t[o],n);else{var s=i instanceof SVGElement,c="function"==typeof r;if("style"===t&&"object"==typeof r)d(i,r);else if(s&&c)i[t]=r;else if("dataset"===t)!function e(t,r,n){if("object"==typeof r)for(var i in r)e(t,i,r[i]);else null!=n?t.dataset[r]=n:delete t.dataset[r]}(i,r);else if(s||!(t in i)&&!c||"list"===t){if(s&&"xlink"===t)return void function e(t,r,n){if("object"==typeof r)for(var i in r)e(t,i,r[i]);else null!=n?t.setAttributeNS(p,r,n):t.removeAttributeNS(p,r,n)}(i,r);n&&"class"===t&&(r=i.className+" "+r),null==r?i.removeAttribute(t):i.setAttribute(t,r)}else i[t]=r}}function v(e){return document.createTextNode(null!=e?e:"")}function b(e,t,r){for(var n=0,i=t;n<i.length;n+=1){var o=i[n];if(0===o||o){var s=typeof o;"function"===s?o(e):"string"===s||"number"===s?e.appendChild(v(o)):m(g(o))?l(e,o):o.length?b(e,o,r):"object"===s&&f(e,o,null,r)}}}function y(e){return"string"==typeof e?O(e):g(e)}function g(e){return e.nodeType&&e||!e.el&&e||g(e.el)}function m(e){return e&&e.nodeType}var w={};function O(e){for(var t,r=[],n=arguments.length-1;n-- >0;)r[n]=arguments[n+1];var i=typeof e;if("string"===i)t=j(e).cloneNode(!1);else if(m(e))t=e.cloneNode(!1);else{if("function"!==i)throw new Error("At least one argument required");var o=e;t=new(Function.prototype.bind.apply(o,[null].concat(r)))}return b(g(t),r,!0),t}var _=O;function j(e){return w[e]||(w[e]=n(e))}function P(e){for(var t=[],r=arguments.length-1;r-- >0;)t[r]=arguments[r+1];for(var n=g(e),o=k(e,t,n.firstChild);o;){var s=o.nextSibling;i(e,o),o=s}}function k(e,t,r){for(var n=r,i=new Array(t.length),o=0;o<t.length;o++)i[o]=t[o]&&g(t[o]);for(var s=0;s<t.length;s++){var c=t[s];if(c){var a=i[s];if(a!==n)if(m(a)){var u=n&&n.nextSibling,d=null!=c.__redom_index&&u===i[s+1];l(e,c,n,d),d&&(n=u)}else null!=c.length&&(n=k(e,c,n));else n=n.nextSibling}}return n}O.extend=function(e){for(var t=[],r=arguments.length-1;r-- >0;)t[r]=arguments[r+1];var n=j(e);return O.bind.apply(O,[this,n].concat(t))};var S=function(e,t,r){this.View=e,this.initData=r,this.oldLookup={},this.lookup={},this.oldViews=[],this.views=[],null!=t&&(this.key="function"==typeof t?t:function(e){return function(t){return t[e]}}(t))};S.prototype.update=function(e,t){for(var r=this.View,n=this.key,i=this.initData,o=null!=n,s=this.lookup,c={},a=new Array(e.length),l=this.views,u=0;u<e.length;u++){var d=e[u],h=void 0;if(o){var p=n(d);h=s[p]||new r(i,d,u,e),c[p]=h,h.__redom_id=p}else h=l[u]||new r(i,d,u,e);h.update&&h.update(d,u,e,t),g(h.el).__redom_view=h,a[u]=h}this.oldViews=l,this.views=a,this.oldLookup=s,this.lookup=c};var E=function(e,t,r,n){this.View=t,this.initData=n,this.views=[],this.pool=new S(t,r,n),this.el=y(e),this.keySet=null!=r};E.prototype.update=function(e,t){void 0===e&&(e=[]);var r=this.keySet,n=this.views;this.pool.update(e,t);var o=this.pool,s=o.views,c=o.lookup;if(r)for(var a=0;a<n.length;a++){var l=n[a];null==c[l.__redom_id]&&(l.__redom_index=null,i(this,l))}for(var u=0;u<s.length;u++){s[u].__redom_index=u}P(this,s),r&&(this.lookup=c),this.views=s},E.extend=function(e,t,r,n){return E.bind(E,e,t,r,n)},E.extend;var x=function(e,t){this.el=v(""),this.visible=!1,this.view=null,this._placeholder=this.el,e instanceof Node?this._el=e:e.el instanceof Node?(this._el=e,this.view=e):this._View=e,this._initData=t};x.prototype.update=function(e,t){var r=this._placeholder,n=this.el.parentNode;if(e){if(!this.visible)if(this._el)l(n,this._el,r),i(n,r),this.el=g(this._el),this.visible=e;else{var o=new(0,this._View)(this._initData);this.el=g(o),this.view=o,l(n,o,r),i(n,r)}this.view&&this.view.update&&this.view.update(t)}else if(this.visible){if(this._el)return l(n,r,this._el),i(n,this._el),this.el=r,void(this.visible=e);l(n,r,this.view),i(n,this.view),this.el=r,this.view=null}this.visible=e};var D=function(e,t,r){this.el=y(e),this.Views=t,this.initData=r};D.prototype.update=function(e,t){if(e!==this.route){var r=this.Views[e];this.route=e,r&&(r instanceof Node||r.el instanceof Node)?this.view=r:this.view=r&&new r(this.initData,t),P(this.el,[this.view])}this.view&&this.view.update&&this.view.update(t,e)};var N="http://www.w3.org/2000/svg",T={};function C(e){for(var t,r=[],n=arguments.length-1;n-- >0;)r[n]=arguments[n+1];var i=typeof e;if("string"===i)t=L(e).cloneNode(!1);else if(m(e))t=e.cloneNode(!1);else{if("function"!==i)throw new Error("At least one argument required");var o=e;t=new(Function.prototype.bind.apply(o,[null].concat(r)))}return b(g(t),r,!0),t}function L(e){return T[e]||(T[e]=n(e,N))}C.extend=function(e){var t=L(e);return C.bind(this,t)},C.ns=N;var q={position:"absolute",top:0,left:0,"z-index":0,"background-color":"#000"};var A=class{constructor(e){let{shortName:t,longName:r,author:n,description:i,firstScene:o,language:s,scenes:c}=e;this.shortName=t,this.longName=r,this.author=n,this.description=i,this.firstScene=o,this.scenes=c,this.language=s}},V={width:"100%",height:"100%"};var M=class{constructor(e){this.events=e,this.queue=this.build(),this.index=0,this.sort("asc")}get pending(){if(!(this.index>this.queue.length-1))return this.queue[this.index]}getTimedObject(e){return this.events[e]}advance(){this.index+=1}build(){const e=[];for(let t=0;t<this.events.length;t+=1){const r={id:t,time:this.events[t].in,action:"start"},n={id:t,time:this.events[t].out,action:"stop"};e.push(r,n)}return e}sort(e){switch(e){case"desc":this.queue.sort((e,t)=>t.time-e.time);break;case"asc":default:this.queue.sort((e,t)=>e.time-t.time)}}};class R extends Error{}class F{constructor(e){let{events:t,startEventCallback:r,stopEventCallback:n}=e;this.queue=new M(t),this.startEventCallback=r,this.stopEventCallback=n,this.tokenTimeUpdate=z.register("video:timeupdate",this.isReadyToAction,this)}unRegister(){z.unRegister(this.tokenTimeUpdate)}isReadyToAction(e){if(!e)return;const t=function(e){return 1e3*e}(e);t&&this.queue.pending&&t>=this.queue.pending.time&&this.parseAction(this.queue.pending)}parseAction(e){const t=this.queue.events[e.id];if(!t)throw new R("Event data not found");switch(e.action){case"start":this.startEventCallback(t);break;case"stop":this.stopEventCallback(t);break;default:return}this.queue.advance()}}(()=>{let e})();function U(e,t){let r=t-e;return void 0===e&&(e=0),r<=0&&(r=t,e=0),Math.floor(Math.random()*r)+e}const z=new class{static tokenGenerator(e){if("number"!=typeof e)throw new Error("Length not a number");const t=[];for(let r=0;r<e;r+=1){let e;do{e=U(48,122)}while(e>57&&e<65||e>90&&e<97);t.push(String.fromCharCode(e))}return t.join("")}constructor(){this.registry={}}broadcast(e,t){this.registry[e]?Object.values(this.registry[e]).forEach(e=>{e.handler.call(e.context,t)}):console.warn("Channel not registered:",e)}unRegister(e){const t=Object.keys(this.registry).filter(t=>Object.keys(this.registry[t]).includes(e));t?(delete this.registry[t][e],Object.keys(this.registry[t]).length||delete this.registry[t]):console.warn("Token not found")}register(e,t,r){const n=this.constructor.tokenGenerator(32);return this.registry[e]||(this.registry[e]={}),this.registry[e][n]={handler:t,context:r},n}};var G=class{constructor(e){var t;this.events=(t={events:e,startEventCallback:this.start,stopEventCallback:this.stop},new F(t))}start(e){let{moduleName:t,payload:r}=e;z.broadcast("director:sceneevent",{action:"start",moduleName:t,payload:r})}stop(e){let{moduleName:t,payload:r}=e;z.broadcast("director:sceneevent",{action:"stop",moduleName:t,payload:r})}},J={position:"absolute",bottom:"20px",height:"5px",width:"100%","background-color":"#fff"};const B={height:"5px",width:"0px","background-color":"yellow"};function I(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function W(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?I(Object(r),!0).forEach((function(t){H(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):I(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function H(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}var K=class{constructor(){this.el=_(".progressCounter",{style:W({},B)})}update(){const e=(arguments.length>0&&void 0!==arguments[0]?arguments[0]:0)/(arguments.length>1?arguments[1]:void 0)*100;d(this.el,{width:"".concat(e,"%")})}};function Q(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function X(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?Q(Object(r),!0).forEach((function(t){Y(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):Q(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function Y(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}var Z=class{constructor(){this.el=_("",{style:X({},J)},this.progressCounter=new K),this.duration=999,this.tokenDurationChanged=z.register("video:durationchange",e=>{this.duration=e}),this.tokenTimeUpdate=z.register("video:timeupdate",this.updateProgress,this)}updateProgress(e){this.progressCounter.update(e,this.duration)}};class $ extends Error{}var ee=class{constructor(e,t){this.el=_("source",{src:t,type:this.mapFileFormatToMediaType(e)})}mapFileFormatToMediaType(e){switch(e){case"mp4":return"video/mp4";case"ogg":return"video/ogg";case"webm":return"video/webm";default:throw new $("Unable to process source in Video file")}}},te={width:"100%",height:"100%","object-fit":"contain"};function re(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function ne(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?re(Object(r),!0).forEach((function(t){ie(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):re(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function ie(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}class oe extends Error{}var se=class{constructor(e){let{controls:t=!1,loop:r=!1,muted:n=!1,sources:i={}}=e;this.el=_("",{autoplay:!1,controls:t,loop:r,muted:n,style:ne({},te)}),this.sources=this.setSources(i),this.mountSources(),this.listenToVideoEvents(),this.tokenPause=z.register("director:pause",this.pause,this),this.tokenPlay=z.register("director:play",this.play,this)}setSources(e){if(!e)throw new oe("No video sources found");const t={};for(const r in e)e.hasOwnProperty(r)&&(t[r]=new ee(r,e[r]));return t}mountSources(){for(const e in this.sources){if(!this.sources.hasOwnProperty(e))continue;const t=this.sources[e];l(this.el,t.el)}}listenToVideoEvents(){this.el.addEventListener("ended",()=>{z.broadcast("video:ended")}),this.el.addEventListener("durationchange",()=>{z.broadcast("video:durationchange",this.el.duration)}),this.el.addEventListener("paused",()=>{z.broadcast("video:paused")}),this.el.addEventListener("playing",()=>{z.broadcast("video:playing",this.el.currentTime)}),this.el.addEventListener("seeked",()=>{z.broadcast("video:seeked",this.el.currentTime)}),this.el.addEventListener("seeking",()=>{z.broadcast("video:seeking",this.el.currentTime)}),this.el.addEventListener("timeupdate",()=>{z.broadcast("video:timeupdate",this.el.currentTime)})}stopListeningToRadio(){z.unRegister(this.tokenPause),z.unRegister(this.tokenPlay)}play(){this.el.play().then(()=>{}).catch(()=>{})}pause(){this.el.pause()}playPause(){this.el.paused?this.play():this.pause()}};function ce(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function ae(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?ce(Object(r),!0).forEach((function(t){le(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):ce(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function le(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}var ue=class{constructor(e,t){let{events:r,longName:n,video:i}=t;z.broadcast("director:scenechange",e),this.el=_("",{style:ae({},V)},this.timeline=new Z,this.video=new se(i)),this.events=new G(r),this.longName=n,this.video.play()}};new class{constructor(){this.currentScene="",this.registerListeners()}registerListeners(){z.register("director:scenechange",e=>{this.currentScene=e})}};const de=new class{constructor(){this.currentDuration=0,this.currentTime=0,this.registerListeners()}registerListeners(){z.register("video:durationchange",e=>{this.currentDuration=e}),z.register("video:timeupdate",e=>{this.currentTime=e})}};function he(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function pe(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?he(Object(r),!0).forEach((function(t){fe(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):he(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function fe(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}var ve=class{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this.el=_("",{style:pe(pe({},q),{},{width:"".concat(e.width,"px"),height:"".concat(e.height,"px")})}),this.story={},this.scene={},this.setupSyntheticEvents()}currentDuration(){return de.currentDuration}currentTime(){return de.currentTime}setStory(e){this.story=new A(e)}loadScene(e){this.scene&&this.unloadScene(),this.scene=new ue(e,this.story.scenes[e]),l(this.el,this.scene)}unloadScene(){i(this.el,this.scene)}pause(){z.broadcast("director:pause")}play(){z.broadcast("director:play")}resize(e,t){d(this.el,{width:"".concat(e,"px"),height:"".concat(t,"px")})}setupSyntheticEvents(){z.register("director:sceneevent",e=>{this.el.dispatchEvent(new CustomEvent("director:sceneevent",{detail:e}))},this)}},be=r(0);function ye(e,t){const r=be.version,n=new ve(t);return l(e,n),{currentDuration:()=>n.currentDuration(),currentTime:()=>n.currentTime(),el:n.el,loadScriptFromJson(e){try{return n.setStory(e),n.loadScene(n.story.firstScene),Promise.resolve()}catch(e){return Promise.reject("Unable to load JSON, ".concat(e))}},pause(){n.pause()},play(){n.play()},reloadScene(){n.loadScene()},resize(e,t){n.resize(e,t)},skipTo(e){n.loadScene(e)},version:r,v:r}}}]).default}));